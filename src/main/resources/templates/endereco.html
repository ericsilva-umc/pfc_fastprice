<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FastPrice - Cadastro de Endereço</title>
        <link rel="icon" type="image/png" href="imgs/cart.png">
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/style_address_form.css">
    </head>

    <body>
        <div class="container">
            <!--Inclui o header da página-->
            <header th:replace="~{fragments/header :: header}"></header>

            <!-- RegisterAddres Card -->
            <div class="register-card mt-5">
                <h1 class="text-center mb-4">Cadastro de Endereço</h1>
                <form th:action="@{/endereco/cadastrar}" method="POST">
                    <div class="mb-3">
                        <input type="text" class="form-control" name="cep" placeholder="CEP" maxlength="9" id="cep" required>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="rua" placeholder="Rua" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <input type="text" class="form-control" name="numero" placeholder="Número" required>
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control" name="complemento" placeholder="Complemento">
                        </div>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control disabled-field" name="cidade-disabled" placeholder="Cidade" disabled>
                        <input type="text" name="cidade" hidden>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control disabled-field" name="estado-disabled" placeholder="Estado" disabled>
                        <input type="text" name="estado" hidden>
                    </div>
                    <div class="text-center mt-4">
                        <input type="submit" class="btn btn-primary w-100 py-3 mt-2">Salvar
                        <!--<a class="m-3" href="registered_address.html">Clique para ir ao Endereço Cadastrado.</a>-->
                    </div>
                </form>
            </div>
        </div>

        <script>
            //VIACEP Integration w/ JS, but we need to do it on java for PFC, i think. It worked really well, i liked.
            const cepInput = document.querySelector('input[name="cep"]');
            const cidadeDisabledInput = document.querySelector('input[name="cidade-disabled"]');
            const cidadeInput = document.querySelector('input[name="cidade"]');
            const estadoDisabledInput = document.querySelector('input[name="estado-disabled"]');
            const estadoInput = document.querySelector('input[name="estado"]');
            const ruaInput = document.querySelector('input[name="rua"]');

            cepInput.addEventListener('blur', function () {
                const cep = this.value.replace(/\D/g, '');

                if (cep === '') {
                    cidadeDisabledInput.value = '';
                    cidadeInput.value = '';
                    estadoDisabledInput.value = '';
                    estadoInput.value = '';
                    ruaInput.value = '';
                    return;
                }

                if (cep.length === 8) {
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                            .then(response => response.json())
                            .then(data => {
                                if (!data.erro) {
                                    cidadeDisabledInput.value = data.localidade;
                                    cidadeInput.value = cidadeDisabledInput.value;
                                    estadoDisabledInput.value = data.uf;
                                    estadoInput.value = estadoDisabledInput.value;
                                    ruaInput.value = data.logradouro;
                                } else {
                                    cidadeDisabledInput.value = '';
                                    cidadeInput.value = '';
                                    estadoDisabledInput.value = '';
                                    estadoInput.value = '';
                                    ruaInput.value = '';
                                    alert("CEP não localizado, certifique-se que ele está certo.");
                                }
                            })
                            .catch(() => {
                                cidadeDisabledInput.value = '';
                                cidadeInput.value = '';
                                estadoDisabledInput.value = '';
                                estadoInput.value = '';
                                ruaInput.value = '';
                                alert("Erro ao tentar localizar o CEP.");
                            });
                } else {
                    cidadeDisabledInput.value = '';
                    cidadeInput.value = '';
                    estadoDisabledInput.value = '';
                    estadoInput.value = '';
                    ruaInput.value = '';
                }
            });

            // Format cep 
            document.getElementById('cep').addEventListener('input', function () {
                let cep = this.value.replace(/\D/g, '');

                if (cep.length > 5) {
                    cep = cep.slice(0, 5) + '-' + cep.slice(5, 8);
                }

                this.value = cep;
            });
        </script>
    </body>

</html>